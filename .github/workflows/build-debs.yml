name: Build DSView Debian Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version (e.g. 1.3.2)'
        required: false
        default: '1.3.2'

env:
  PKG_NAME: dsview
  PKG_VERSION: ${{ github.event.inputs.version || '1.3.2' }}
  PKG_RELEASE: 1

jobs:
  build:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            qemu: false
          - arch: arm64
            platform: linux/arm64
            qemu: true
          - arch: riscv64
            platform: linux/riscv64
            qemu: true

    name: Build ${{ matrix.arch }}
    timeout-minutes: 720

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        if: matrix.qemu
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Set version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: echo "PKG_VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV

      - name: Build .deb in container
        run: |
          docker run --rm --platform ${{ matrix.platform }} \
            -v ${{ github.workspace }}:/src \
            -v ${{ github.workspace }}/output:/output \
            -e PKG_NAME="${{ env.PKG_NAME }}" \
            -e PKG_VERSION="${{ env.PKG_VERSION }}" \
            -e PKG_RELEASE="${{ env.PKG_RELEASE }}" \
            -e DEBIAN_FRONTEND=noninteractive \
            ubuntu:noble bash -c '
              set -ex

              apt-get update
              apt-get install -y --no-install-recommends \
                build-essential cmake pkg-config git ca-certificates \
                libglib2.0-dev zlib1g-dev libusb-1.0-0-dev \
                libboost-dev libboost-filesystem-dev libboost-system-dev libboost-thread-dev \
                libfftw3-dev python3-dev libudev-dev \
                qtbase5-dev libqt5svg5-dev

              ARCH=$(dpkg --print-architecture)
              PKG_ROOT=/tmp/pkg-root

              cd /src
              mkdir -p builddir && cd builddir

              cmake ../ \
                -DCMAKE_INSTALL_PREFIX=/usr \
                -DCMAKE_BUILD_TYPE=Release

              make -j$(nproc)

              make install DESTDIR=${PKG_ROOT}

              mkdir -p ${PKG_ROOT}/usr/share/applications
              mkdir -p ${PKG_ROOT}/usr/share/pixmaps
              mkdir -p ${PKG_ROOT}/usr/share/DSView

              if [ -f /src/DSView/DSView.desktop ]; then
                cp /src/DSView/DSView.desktop ${PKG_ROOT}/usr/share/applications/ 2>/dev/null || true
              fi
              if [ -f /src/DSView/icons/logo.svg ]; then
                cp /src/DSView/icons/logo.svg ${PKG_ROOT}/usr/share/pixmaps/dsview.svg 2>/dev/null || true
              fi
              if [ -f /src/DSView/icons/logo.png ]; then
                cp /src/DSView/icons/logo.png ${PKG_ROOT}/usr/share/pixmaps/dsview.png 2>/dev/null || true
              fi

              mkdir -p ${PKG_ROOT}/DEBIAN
              INSTALLED_SIZE=$(du -sk ${PKG_ROOT} | cut -f1)

              cat > ${PKG_ROOT}/DEBIAN/control << EOF
          Package: ${PKG_NAME}
          Version: ${PKG_VERSION}-${PKG_RELEASE}
          Architecture: ${ARCH}
          Maintainer: seb@penthertz.com
          Installed-Size: ${INSTALLED_SIZE}
          Depends: libqt5core5t64, libqt5gui5t64, libqt5widgets5t64, libqt5svg5, libusb-1.0-0, libfftw3-single3, libboost-filesystem1.83.0, libboost-system1.83.0, libboost-thread1.83.0, zlib1g, libglib2.0-0t64
          Provides: dsview
          Section: electronics
          Priority: optional
          Homepage: https://www.dreamsourcelab.com
          Description: DSView - Multi-function instrument GUI
           DSView is an open-source multi-function instrument GUI for
           DreamSourceLab hardware including DSLogic logic analyzers,
           DSCope oscilloscopes, and DSLogic protocol analyzers.
          EOF

              printf "#!/bin/bash\nset -e\nldconfig\nif [ -d /usr/share/libsigrokdecode4DSL ] && [ ! -e /usr/local/share/libsigrokdecode4DSL ]; then\n    mkdir -p /usr/local/share\n    ln -s /usr/share/libsigrokdecode4DSL /usr/local/share/libsigrokdecode4DSL\nfi\n" > ${PKG_ROOT}/DEBIAN/postinst
              chmod 755 ${PKG_ROOT}/DEBIAN/postinst

              printf "#!/bin/bash\nset -e\nldconfig\nif [ -L /usr/local/share/libsigrokdecode4DSL ]; then\n    rm -f /usr/local/share/libsigrokdecode4DSL\nfi\n" > ${PKG_ROOT}/DEBIAN/postrm
              chmod 755 ${PKG_ROOT}/DEBIAN/postrm

              DEB_FILE="/output/${PKG_NAME}_${PKG_VERSION}-${PKG_RELEASE}_${ARCH}.deb"
              dpkg-deb --build ${PKG_ROOT} ${DEB_FILE}

              echo "=== Built package ==="
              ls -lh ${DEB_FILE}
              dpkg-deb --info ${DEB_FILE}
              dpkg-deb --contents ${DEB_FILE} | head -50
            '

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PKG_NAME }}_${{ env.PKG_VERSION }}-${{ env.PKG_RELEASE }}_${{ matrix.arch }}
          path: output/*.deb
          retention-days: 90

  release:
    needs: build
    runs-on: ubuntu-24.04
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: debs
          merge-multiple: true

      - name: List packages
        run: |
          echo "=== Built packages ==="
          ls -lh debs/
          for f in debs/*.deb; do
            echo "--- $(basename $f) ---"
            dpkg-deb --info "$f" | grep -E "(Package|Version|Architecture|Installed-Size|Depends)"
          done

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: debs/*.deb
          generate_release_notes: true
          body: "Pre-built DSView Debian packages for Ubuntu Noble (24.04). Architectures: amd64, arm64, riscv64."

      - name: Upload debs for manual dispatch
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: all-debs-${{ env.PKG_VERSION }}
          path: debs/*.deb
          retention-days: 90